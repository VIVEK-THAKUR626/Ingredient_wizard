{% extends "base.html" %}
{% load static %}

{% block title %}Recipe Finder{% endblock %}

{% block content %}
<div class="container mt-4">

    {% if user.is_authenticated %}
        <p>Welcome, {{ user.username }}! </p>
    {% else %}
        <div>
            <h2>Login</h2>
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="login" value="1">
                <input type="text" name="username" placeholder="Username" required>
                <input type="password" name="password" placeholder="Password" required>
                <button type="submit" class="btn btn-primary">Login</button>
            </form>

            <h2 class="mt-4">Sign Up</h2>
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="signup" value="1">
                <input type="text" name="username" placeholder="Username" required>
                <input type="password" name="password" placeholder="Password" required>
                <button type="submit" class="btn btn-success">Sign Up</button>
            </form>
        </div>
    {% endif %}

    <h1 class="mt-4">Find Recipes</h1>
    <form method="POST" class="mb-4">
        {% csrf_token %}
        <div class="mb-2">
            <label for="ingredients">Ingredients (comma-separated):</label>
            <input type="text" id="ingredients" name="ingredients" class="form-control" required>
            <button type="button" onclick="startDictation()">üéôÔ∏è</button>
        </div>
        <div class="mb-2">
            <label for="diet">Dietary Preference:</label>
            <select name="diet" id="diet" class="form-select">
                <option value="">None</option>
                <option value="vegetarian">Vegetarian</option>
                <option value="vegan">Vegan</option>
                <option value="gluten free">Gluten Free</option>
                <option value="ketogenic">Ketogenic</option>
                <option value="pescetarian">Pescetarian</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="cuisine">Cuisine / Ethnicity:</label>
            <select name="cuisine" id="cuisine" class="form-select">
                <option value="">Any</option>
                <option value="indian">Indian</option>
                <option value="chinese">Chinese</option>
                <option value="italian">Italian</option>
                <option value="mexican">Mexican</option>
                <option value="thai">Thai</option>
                <option value="french">French</option>
            </select>
        </div>
        <button type="submit" class="btn btn-primary">Find Recipes</button>
    </form>

    {% if recipes %}
        <h2>Recipes:</h2>
        <ul class="list-group">
            {% for recipe in recipes %}
                <li class="list-group-item">
                    <a href="{% url 'recipe_detail' recipe.id %}">{{ recipe.title }}</a>
                    {% if recipe.usedIngredientCount is not None %}
                        <p>Used Ingredients: {{ recipe.usedIngredientCount }} / {{ recipe.missedIngredientCount }} missing</p>
                    {% endif %}
                </li>
            {% endfor %}
        </ul>
    {% endif %}
</div>

<script>
    function startDictation() {
        if (window.hasOwnProperty('webkitSpeechRecognition')) {
            var recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = "en-US";

            recognition.start();

            recognition.onresult = function(event) {
                document.getElementById("ingredients").value = event.results[0][0].transcript;
                recognition.stop();
            };

            recognition.onerror = function(event) {
                recognition.stop();
                alert("Error occurred in recognition: " + event.error);
            };
        } else {
            alert("Speech Recognition not supported in this browser.");
        }
    }
</script>
{% endblock %}
